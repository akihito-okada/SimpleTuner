package com.example.simpletuner.tuner

/**
 * 音が鳴り始めた直後（アタック音）を無視するためのフィルタ。
 *
 * ギターなどの弦楽器では、
 * ・弦を弾いた瞬間はノイズや倍音が非常に多い
 * ・このタイミングでピッチ検出をするとブレや誤検出が出やすい
 *
 * そこで、
 * 「音が鳴り始めてから一定時間が経過するまで」は
 * ピッチ検出結果を使わない、という割り切りをしています。
 *
 * このクラスは、
 * GateState によって「音が鳴っている」と判定された後の
 * 時間的な安定性を担保する役割を持ちます。
 */
class PitchStabilityFilter(
    // アタック音として無視する時間（ミリ秒）
    // 例: 200ms = 弦を弾いた直後の不安定な区間
    private val attackIgnoreMs: Long = 200
) {
    // 「音が鳴り始めた瞬間」の時刻（ms）
    // hasSignal が true になった最初のフレームでセットされる
    private var lastOnsetTime: Long = 0L

    /**
     * 現在の信号状態を受け取り、
     * 「今はピッチを使ってよい安定状態か」を返す。
     *
     * @param hasSignal GateState による音量判定結果
     * @return true  = 安定しているのでピッチ検出を許可
     *         false = まだアタック中なので結果を捨てる
     */
    fun filter(hasSignal: Boolean): Boolean {
        val now = System.currentTimeMillis()

        // ---------------------------------------------------------
        // 音が鳴り始めた瞬間
        // ---------------------------------------------------------
        if (hasSignal && lastOnsetTime == 0L) {
            // 初めて「音あり」になった時刻を記録
            lastOnsetTime = now

            // このフレームはアタック中として捨てる
            return false
        }

        // ---------------------------------------------------------
        // 音が止まった場合
        // ---------------------------------------------------------
        if (!hasSignal) {
            // 次に鳴ったときに再びアタック判定できるようリセット
            lastOnsetTime = 0L
        }

        // ---------------------------------------------------------
        // 音が鳴り始めてから十分時間が経過しているか
        // ---------------------------------------------------------
        // attackIgnoreMs を超えていれば「安定した音」とみなす
        return now - lastOnsetTime > attackIgnoreMs
    }
}

