package com.example.simpletuner.tuner

/**
 * 入力音量（dB）に対して「今は音が鳴っているとみなすか？」を判定するゲート。
 *
 * いわゆるノイズゲートの超簡易版で、
 * ・無音や環境ノイズでは閉じる
 * ・一度開いたら、多少音量が下がってもすぐには閉じない
 *
 * という **ヒステリシス付きのON/OFF判定**を行います。
 *
 * チューナー用途では、
 * ・「鳴らしていないのにHzが出る」
 * ・「鳴らしている途中で判定が頻繁に切れる」
 *
 * これらを防ぐための前段フィルタとして使います。
 */
class GateState(
    // ゲートを「開く」ために必要な音量の下限（dB）
    // これ以上の音量になったら「音が鳴っている」と判定する
    private val openDb: Float = -60f,

    // ゲートが「閉じる」判定になる音量の下限（dB）
    // openDb より小さくしておくことで、ヒステリシスを作る
    private val closeDb: Float = -68f
) {
    // 現在ゲートが開いているかどうかの状態
    private var isOpen: Boolean = false

    /**
     * 現在の音量（dB）を入力し、
     * 「音が鳴っている状態かどうか」を更新して返す。
     *
     * @param db 直近フレームの音量（RMSをdBに変換した値）
     * @return   ゲートが開いているかどうか（true = 有効な信号あり）
     */
    fun update(db: Float): Boolean {

        isOpen = if (isOpen) {
            // すでにゲートが開いている場合：
            // 少し音量が下がっても、closeDb を下回るまでは開いたままにする
            //
            // → 弦の減衰途中で判定がブツブツ切れるのを防ぐ
            db >= closeDb
        } else {
            // まだゲートが閉じている場合：
            // openDb を超えたときだけ開く
            //
            // → 環境ノイズや微小音で誤って開かないようにする
            db >= openDb
        }

        // 更新後の状態をそのまま返す
        return isOpen
    }
}

